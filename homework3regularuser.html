<!DOCTYPE html>
<html>
  <head>
    <script src="https://cloudboost.io/js-sdk/cloudboost.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  </head>
  <body>
    <h5>

      Select some stores near you to look at their inventories:

      <br>
      To look at a particular item, just click on it
      <br>
      <br>
      Walmart <input type="checkbox" class="storesToLookAt" name="Walmart"><br>
      Target <input type="checkbox" class="storesToLookAt" name="Target"><br>
      Whole Foods <input type="checkbox" class="storesToLookAt" name="Whole Foods"><br>
      Home Depot <input type="checkbox" class="storesToLookAt" name="Home Depot"><br>
      Amazon <input type="checkbox" class="storesToLookAt" name="Amazon"><br>
      Costco <input type="checkbox" class="storesToLookAt" name="Costco"><br>
      Walgreens <input type="checkbox" class="storesToLookAt" name="Walgreens"><br>
      Fairway <input type="checkbox" class="storesToLookAt" name="Fairway"><br>
    <button id="look">Look at  these stores</button>
    <p id="storeInventories"></p>
    </h5>
    <script>

      $("#look").click(()=>{
        CB.CloudApp.init('almxwdbwxvmx', 'c0044bb7-6c34-41af-a953-eca3928648c9');
        let stores=[];
              for(let i=0;i<$(".storesToLookAt").length;i++){
                if($(".storesToLookAt")[i].checked===true){
                  stores.push($(".storesToLookAt")[i].name);
                }
              }
        $("#storeInventories").empty();
        console.log(stores)
        let query= new CB.CloudQuery("Stores");
        console.log(query)
        for(let i=0;i<stores.length;i++){
          query.equalTo("name",stores[i])
          query.find({
            success: function(lst){
              console.log(lst)

              for(let j=0;j<lst.length;j++){
                  let currentStore=lst[j]

                  let currentStoreName=currentStore.get("name")
                    let itemquery=new CB.CloudQuery("Product");

                    itemquery.equalTo("storeId",currentStore.get("id"))
                    console.log(currentStore.get("id"))
                    itemquery.find({
                      success: function(thisItemList){
                        console.log(thisItemList)
                        if(thisItemList.length===0){
                          $("#storeInventories").append("<b>"+stores[i]+"</b> has no items<br><br>")
                        }
                        else{
                        $("#storeInventories").append("<b>"+currentStoreName+"</b><br>")
                        for(let l=0;l<thisItemList.length;l++){
                          let thisItem=thisItemList[l];
                          console.log(`<div class='item' store='${thisItem.get("storeId")}' value='${thisItem.get("name")}'> ${thisItem.get("name")} for $${thisItem.get("price")} </div>`)
                          $("#storeInventories").append(`<div class='item' store='${thisItem.get("storeId")}' value='${thisItem.get("name")}'> ${thisItem.get("name")} for $${thisItem.get("price")} </div>`)
                        }
                        $("#storeInventories").append("<br>")
                      }
                    },
                      error: function(errormessage){
                        console.log(errormessage)

                      }
                    })

              }
            },
            error: function(errormessage){
              console.log(errormessage)
            }
        })
        }
      })
      $(document).on("click", ".item", function(value){
        console.log(value)
        let thisitem=value.toElement.outerHTML
        console.log(thisitem)
        let store=(thisitem.split("=")[2]).split("\"")[1]
        let itemname=(thisitem.split("=")[3]).split("\"")[1]
        console.log(itemname)
        window.location.href="file:///Users/pazmacias/Documents/nano-extra-master/nha-apis-spring-2016/week-3/homework3item.html?item="+itemname+"&storeId="+store
      })



    </script>
  </body>
</html>
